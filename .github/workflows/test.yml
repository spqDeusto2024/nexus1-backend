name: CI - Integration Test

on:
  push:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]

    steps:
      # Checkout el código
      - name: Git checkout
        uses: actions/checkout@v2

      # Construcción de la imagen Docker
      - name: Build Docker container
        run: bash build.sh

      # Levantar los servicios con docker-compose
      - name: Start docker-compose 
        run: docker-compose up -d

      # Esperar a que los servicios estén disponibles
      - name: Wait for services to be up
        run: |
          sleep 10
          docker-compose ps

      # Verificar que la base de datos está accesible (ejemplo usando PostgreSQL)
      - name: Check database is up
        run: |
          docker exec -i <nombre_contenedor_db> psql -U <usuario> -c '\l'

      # Verificar que FastAPI está accesible
      - name: Check FastAPI is up
        run: |
          curl -f http://localhost:8000/docs || exit 1

      # Instalar dependencias para pruebas
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx pytest

      # Ejecutar pruebas unitarias
      - name: Run unit tests
        run: pytest tests/

      # Apagar los servicios al final
      - name: Stop docker-compose
        run: docker-compose down
